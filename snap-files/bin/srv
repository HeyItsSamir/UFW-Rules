#!/bin/sh
set -e

if [ -z "$SNAP" ]; then
    echo "SNAP not set"
    exit 1
fi

files_to_merge="before.rules before6.rules after.rules after6.rules"
upgrade_path="$SNAP_DATA/.upgraded_${SNAP_REVISION}"
prev_rules="$SNAP_DATA/.rules.orig"

copy_if_same() {
    bn="$1"
    prev_shipped="$prev_rules/$bn"
    inuse="$SNAP_DATA/etc/ufw/$bn"
    new_shipped="$SNAP/usr/share/ufw/iptables/$bn"

    # if the old shipped rules are the same as the rules in use (ie, the admin
    # didn't change them), then if the new rules are different, copy them over
    if diff "$prev_shipped" "$inuse" >/dev/null ; then
        if ! diff "$new_shipped" "$prev_shipped" > /dev/null ; then
            echo "Updating '$bn'"
            cp -f --preserve=mode "$new_shipped" "$inuse"
        else
            echo "'$bn' is unchanged"
        fi
    else
        echo "'$bn' has changes that cannot be merged. For details, see:"
        echo "$ diff -Nau $new_shipped $inuse"
    fi
}

# First run, none of this exists, so just copy over wholesale
if [ ! -e "$SNAP_DATA/lib" ]; then
    cp -fr --preserve=mode "$SNAP/lib" "$SNAP_DATA"
fi
if [ ! -e "$SNAP_DATA/etc" ]; then
    cp -fr --preserve=mode "$SNAP/etc" "$SNAP_DATA"
    chmod 640 "$SNAP_DATA"/etc/ufw/*.rules
    chmod 640 "$SNAP_DATA"/etc/ufw/*.init
fi

# Next, make sure these files are available for upgrade comparisons
if [ ! -e "$prev_rules" ]; then
    mkdir "$prev_rules"
fi

# On upgrades, detect if the rules file matches the shipped file, and if
# so, apply any changes to the rules file (ie, emulate ucf)
if [ ! -e "$upgrade_path" ]; then
    for fn in $files_to_merge ; do
        if [ -e "$prev_rules/$fn" ]; then
            copy_if_same "$fn"
        fi
        # unconditionally create/overwrite the new, upgraded rules for
        # comparison on next upgrade
        cp -f --preserve=mode "$SNAP/usr/share/ufw/iptables/$fn" "$prev_rules"
    done

    # remove old for housekeeping
    rm -f "$SNAP_DATA/.upgraded*"

    # add new
    touch "$upgrade_path"
fi

"$SNAP"/lib/ufw/ufw-init --rootdir "$SNAP" --datadir "$SNAP_DATA" start
